<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Abrir o descargar múltiples enlaces</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Segoe UI,Arial;padding:20px}
    #msg{margin-left:12px;color:#555}
    button{padding:10px 16px;font-size:16px;cursor:pointer;margin-right:8px}
    .note{color:#666;font-size:14px;margin:8px 0 16px}
  </style>
</head>
<body>
  <h2>Abrir o descargar múltiples enlaces</h2>
  <p class="note">
    Este botón convierte automáticamente los links de Google Drive <code>/file/d/{id}/view</code> a
    <code>https://drive.usercontent.google.com/download?id={id}</code> para forzar descarga.
    Si tu navegador bloquea ventanas emergentes, permite pop-ups y descargas automáticas para este sitio.
  </p>

  <button id="open">Abrir (ver)</button>
  <button id="download">Descargar (forzar)</button>
  <span id="msg"></span>

  <ul id="list" style="margin-top:14px"></ul>

  <script>
  (function () {
    // 1) Leer URLs desde ?u=... o #...
    const qs = new URLSearchParams(location.search);
    let raw = qs.get("u") || "";
    if (!raw && location.hash) raw = location.hash.slice(1);

    const originalUrls = (raw||"")
      .split("|")
      .map(decodeURIComponent)
      .map(s => s.trim())
      .filter(Boolean);

    const ul  = document.getElementById("list");
    const msg = document.getElementById("msg");
    const btnOpen = document.getElementById("open");
    const btnDown = document.getElementById("download");

    if (originalUrls.length === 0) {
      ul.innerHTML = "<li>No llegaron enlaces.</li>";
      btnOpen.disabled = true;
      btnDown.disabled = true;
      return;
    }

    // 2) Funciones de conversión
    function toDownloadLink(u){
      // /file/d/{id}/view?...  ->  usercontent download
      const m = u.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)/i);
      if (m && m[1]) return "https://drive.usercontent.google.com/download?id=" + m[1];
      // ya viene con uc?export=download&id=...
      if (/drive\.google\.com\/uc\?/.test(u)) return u;
      return u;
    }

    // 3) Pintar lista visible (los originales para referencia)
    originalUrls.forEach(u=>{
      const li=document.createElement("li");
      const a=document.createElement("a");
      a.href=u; a.target="_blank"; a.rel="noopener";
      a.textContent=u;
      li.appendChild(a);
      ul.appendChild(li);
    });

    // 4) Abrir en nuevas pestañas en un solo gesto (mejor contra bloqueadores)
    function openAll(list){
      let opened = 0;
      const wins = [];
      for (let i = 0; i < list.length; i++) {
        try {
          const w = window.open("about:blank", "_blank");
          if (w) { wins.push(w); opened++; }
        } catch(e){}
      }
      for (let i = 0; i < wins.length; i++) {
        try { wins[i].location = list[i]; } catch(e){}
      }
      if (opened === 0) {
        msg.textContent = "Bloqueado. Permite pop-ups para este sitio y vuelve a intentar.";
      } else if (opened < list.length) {
        msg.textContent = `Se abrieron ${opened} de ${list.length}. Si faltan, permite pop-ups.`;
      } else {
        msg.textContent = `¡Listo! Se intentaron abrir ${list.length}.`;
      }
    }

    // 5) Botones
    btnOpen.addEventListener("click", function(){
      msg.textContent = "";
      openAll(originalUrls);                 // visor
    });

    btnDown.addEventListener("click", function(){
      msg.textContent = "";
      const downloads = originalUrls.map(toDownloadLink); // descarga directa
      openAll(downloads);
    });

    // Intento automático suave (por si ya están permitidos)
    try { originalUrls.forEach(u => window.open(u, "_blank")); } catch(e){}
  })();
  </script>
</body>
</html>
